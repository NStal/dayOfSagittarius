(function(exports){
    var settings = require("./settings").settings;
    var World = require("./share/world.js").World;
    var BattleField = require("./share/battleField").BattleField;
    var SyncWorker = require("./syncWorker").SyncWorker;
    var Game = World.sub();
    Game.prototype._init = function(){
	Game.parent.prototype._init.call(this);
	var self = this;
	this.canvas = document.getElementById(settings.screen);
	this.canvas.width = settings.width;
	this.canvas.height = settings.height;
	window.KEY = {};
	window.onkeydown = function(e){
	    window.KEY[e.which] = true; 
	}
	window.onkeyup = function(e){
	    window.KEY[e.which] = false;
	}
    }
    Game.prototype.start = function(){
	Game.parent.prototype.start.call(this);
	this.syncWorker = new SyncWorker("ws://vuvu:10000",
					 this.battleField.gateway);
	this.syncWorker.start();
    }
    Game.prototype.onmessage = function(){
	console.log("start")
    }
    Game.prototype.next = function(){
	if(!this.battleField.gateway.ready)return;
	this.time+=1;
	var context = this.canvas.getContext("2d");
	context.save();
	this.battleField.next(context);
	console.log(this.battleField.parts.length);

	context.restore();
    }	
    Game.prototype.act = function(msg){
	console.log(msg);
    }
    exports.Game = Game;
})(exports)